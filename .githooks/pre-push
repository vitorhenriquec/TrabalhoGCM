#!/bin/sh

# Branch atual
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD);

# Commits locais que ainda n達o subiram
COMMITS=$(git log $CURRENT_BRANCH --not --remotes --pretty=format:%H);

for COMMIT in $COMMITS;do
    MENSAGEM=$(git log --format=%B -n 1 $COMMIT);
    PADRAO="$(echo $MENSAGEM | grep -o -E '#[0-9]*')";
    NUMERO_ISSUE="$(echo $PADRAO | grep -o -E '[0-9]+')";

    CURL_ARGS="-s -S -k";
    API_URL="https://api.github.com/repos/vitorhenriquec/TrabalhoGCM/issues/$NUMERO_ISSUE";
    TOKEN="-H 'Authorization: Token 3a1a90226d04f35844ebc9d43596efcd79f0a457'";
    JSON="$(curl $CURL_ARGS $API_URL)";

    NOT_FOUND="$(echo $JSON | jq -r '.message')";

    # Se a mensagem for Not Found, ent達o deu 404
    if [ "$NOT_FOUND" = "Not Found" ];then
        echo "Erro: Issue do commit $COMMIT ($PADRAO) n達o encontrada!";
        echo "Push abortado."
        exit 1;
    fi

    # Capturando JSON.state
    STATE="$(echo $JSON | jq -r '.state')";

    if [ "$STATE" = "open" ];then
        echo "Issue do commit $COMMIT ($PADRAO) aberta. Verificando se possui label 'doing'...";
    else
        echo "Erro: Issue do commit $COMMIT ($PADRAO) fechada";
        echo "Push abortado."
        exit 1;
    fi

    # Capturando a quantidade de labels associadas
    LENGTH="$(echo $JSON | jq '.labels | length')";

    NAO_ENCONTROU_DOING=true;

    i=0
    while [ "$i" -lt "$LENGTH" ];do
        PARAMETRO=".labels[$i].name"
        LABEL="$(echo $JSON | jq --compact-output $PARAMETRO)"
        # Verificando se tem label "doing"
        if [ "$LABEL" = "\"doing\"" ];then
            # Achou label "doing"
            NAO_ENCONTROU_DOING=false
            break;
        fi
        i=$(( i + 1 ));
    done

    if $NAO_ENCONTROU_DOING;then
        echo "Issue do commit $COMMIT ($PADRAO) n達o possui a lable Doing. Push abortado."
        exit 1;
    fi
done

PUSH_MENSAGEM="Pushed $COMMITS"
COMENTARIO=""
COMENTARIO="$COMENTARIO$(date +'%d/%m/%y %T') \n"
COMENTARIO="$COMENTARIO$(git config user.name) \n"
COMENTARIO="$COMENTARIO$(git diff --name-only HEAD HEAD~1) \n"
COMENTARIO="$COMENTARIO$PUSH_MENSAGEM"
COMENTARIO="$(echo $COMENTARIO | tr -d '\n')"

CURL_LAST_ARGS='$(curl -X POST -H "Content-Type: application/json" -H "Authorization: Token 3a1a90226d04f35844ebc9d43596efcd79f0a457" -d "{ \"body\":\"$COMENTARIO\"}" https://api.github.com/repos/vitorhenriquec/TrabalhoGCM/issues/$NUMERO_ISSUE/comments)'